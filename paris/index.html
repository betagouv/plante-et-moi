 <!DOCTYPE html>
 <html>
 <head>
	<title>Permis de végétaliser - Ville de Paris</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
	<link rel="stylesheet" href="https://opensource.keycdn.com/fontawesome/4.7.0/font-awesome.min.css" integrity="sha384-dNpIIXE8U05kAbPhy3G1cz+yZmTzA6CY8Vg/u2L9xRnHjJiAK76m2BIEaSEV+/aU" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.rawgit.com/lvoogdt/Leaflet.awesome-markers/v2.0.2/dist/leaflet.awesome-markers.css">
	<link rel="stylesheet" href="https://cdn.rawgit.com/Pixabay/JavaScript-autoComplete/1.0.4/auto-complete.css" />

	<script src="https://cdn.rawgit.com/Pixabay/JavaScript-autoComplete/1.0.4/auto-complete.min.js"></script>
	<script src="https://cdn.rawgit.com/lvoogdt/Leaflet.awesome-markers/v2.0.2/dist/leaflet.awesome-markers.js"></script>

	<style type="text/css">
		body {
  			font-family: "Helvetica", "Arial", sans-serif;
  			line-height: 1.5;
			margin: 0px;  			
		}
		.header__logo {
			background-color: #DF225A; 
			height: 100px;
			width: 100%;
			padding: 0;
			position: relative;
			top: 20px;
		}
		.header__logo__img {
			position: relative;
			top: 10px;
			left: 100px;
			height: 80px;
			max-width: 80%;
		}
		.header {
			background-image: url("https://beta.gouv.fr/img/startup/biodiversite.jpg");
		  	background-position: center top;
		  	background-repeat: no-repeat;
		  	background-size: cover;
		  	height: 300px;
		  	line-height: 1.2;
		  	padding: 0px;
		  	margin: 0 auto;
		  	display: block;
		  	position:relative;
		  	overflow: hidden;
		}
		.header__text {
  		  	text-align: center;
  		  	color: white;
  		  	padding: 30px 10px;
  		  	line-height: 1.5;
		}
		.header__text__title {
			display: inline-block;
			color: white;
			font-size: 20px;
			font-weight: 300;
			text-shadow: 2px 2px #000000;
		}
		.header__button {
			border: 1px solid #003057;
		  	border-radius: 290486px;
		  	background-color:rgba(0, 0, 0, 0.7);
		  	text-transform: uppercase;
		  	text-decoration: none;
		  	transition: none 200ms ease-out;
		  	transition-property: color, background;
		  	padding: 16px 32px;
  			color: white !important;
  			letter-spacing: 0.2px;
  			font-weight: bold;
		}
		.header__ribbon {
			text-align: center;
		    text-transform: uppercase;
		    position: absolute;
		    top: 26px;
		    right: -35px;
		    -webkit-transform: rotate(45deg);
		    transform: rotate(45deg);
		    width: 150px;
		    background-color: #008cba;
		    color: #fff;
		    padding: 5px;
		    font-size: 15px;
		    font-weight: 700;
		    z-index: 10;
		}
		.header__button:hover {
			background-color: #003057;
		}	
		.main {
			margin: 0 auto;
			display: block;
			position:relative;
  			max-width: 950px;
		}
		.main__text {
			margin: 0 auto;
			padding: 1px 5% 30px 5%;
  			color: #555;
  		  	background-color: #F3F3F3;
		}
		.main__form {
			padding: 1px 0px;
  		  	background-color: #F3F3F3;
		}
		.main__form--invisible {
			display: none;
		}
		.main__form__title {
			padding: 1px 5%;
			color: #003057;
		}
		.main__form__typeform {
			width:100%;
			height:600px;
		}
		.main__map {
			width: 100%;
			height: 600px;
			margin: 0 auto;
			padding: 0%;
  		  	text-align: center;
		}
		.main__title {
			color: #003057;
		}
		.main__map__leaflet {
			width: 100%;
			height: 100%;
		}
		.footer {
			padding: 33px;
			text-align: center;
			background-color: #DF225A;
		}
		.footer_button {
  			color: white;
		}
		.footer--invisible {
			display: none;			
		}
		.main__map__input {
			position: absolute;
			width: 400px;
			max-width: 80%;
			padding: 4px 10px;
			margin: 10px;
			font-size: 25px;
		}
		#address-search {
			top: 5px;
			left: 50px;
		}
		.header__button--green {
			background-color: green;
		}
		.header__button--green:hover {
			background-color: green;
		}
		.popup--red .leaflet-popup-content-wrapper {
			background-color: rgba(114, 175, 38, 0.8); 
		}
		.popup--red .leaflet-popup-tip {
			background-color: rgba(114, 175, 38, 0.8); 
		}
	</style>
</head>
<body>
<div class="header">
	<div class="header__logo">
		<img class="header__logo__img" src="img/paris-logo.png"></img>
	</div>
	<div class="header__text">
		<h1 class="header__title">Permis de végétaliser</h1>
		<a class="header__button" href="javascript:launchForm();">Faire ma demande</a>
	</div>
	<div class="header__ribbon">
		Test
	</div>
</div>
<div class="main">
	<div class="main__text">
		<h2 class="main__title">Jardiner dans les rues de Paris, c'est permis !</h2>

		<ul>
  			<li>Les parisiens sont nombreux à exprimer leur envie de jardinage et leur besoin de nature en ville</li>
  			<li>Mais difficile sans jardin ni balcon… </li>
  			<li>La solution ? Jardiner dans l’espace public !</li>
  			<li>Le Permis de végétaliser vous permet de disposer du site de votre choix, et de devenir le jardinier de votre quartier</li>
  		</ul>

		<h2 class="main__title">Quels espaces peut-on végétaliser ?</h2>

		<ul>
  			<li>Depuis 2015, c’est plus de 800 sites <div style="background-color: #72af26; width: 26px; height: 26px; text-align: center; display: inline-block; border-radius: 50%;"><i class="fa fa-leaf" style="color: #fff; margin-top: 4px; display: inline-block; font-size: 12px;"></i></div> qui ont été plantés ! Il ne vous reste qu’à selectionner le vôtre <div style="background-color: #38aadd; width: 26px; height: 26px; text-align: center; display: inline-block; border-radius: 50%;"><i class="fa fa-arrow-down" style="color: #fff; margin-top: 4px; display: inline-block; font-size: 12px;"></i></div> !</li>
  		</ul>


		<div class="main__map">
			<div class="main__map__leaflet" id="map">
				<input type="text" id="address-search" name="address-search" placeholder="Rechercher une adresse" class="main__map__input leaflet-bar leaflet-control">
			</div>
		</div>

	</div>
	<div class="main__form main__form--invisible" id="permit__form">
		<h2 class="main__form__title">Demande de Permis de végétaliser</h2>
			<div class="main__form__typeform typeform-widget" data-url="https://amazingcontent.typeform.com/to/FHwHBi" data-text="Plante et Moi Paris"></div>
			<script>(function(){var qs,js,q,s,d=document,gi=d.getElementById,ce=d.createElement,gt=d.getElementsByTagName,id='typef_orm',b='https://s3-eu-west-1.amazonaws.com/share.typeform.com/';if(!gi.call(d,id)){js=ce.call(d,'script');js.id=id;js.src=b+'widget.js';q=gt.call(d,'script')[0];q.parentNode.insertBefore(js,q)}})()</script>
		</div>
	</div>
<div class="footer" id="footer">
		<a class="footer_button header__button" href="javascript:launchForm();">Demander mon permis de végétaliser</a>
</div>
<script>
	var center = [48.854923, 2.346763];
	var selectedPoint;
	var selectedPointPopup;
	var codePostaux = [];
	var map = L.map('map', {
    	center: center,
    	zoom: 13,
    	minZoom: 10
	});

	L.tileLayer('//{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
    	attribution: 'donn&eacute;es &copy; <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
    	minZoom: 1,
    	maxZoom: 20
	}).addTo(map); 

	var moveMarker = L.AwesomeMarkers.icon({
    	icon: 'arrow-down',
    	markerColor: 'blue',
    	prefix: 'fa'
  	});

	function selectPoint(latlng) {
    	try { map.removeLayer(selectedPoint); } catch(e){}

		selectedPoint = L.marker(latlng, {
							draggable: true,
							clickable: false,
							icon: moveMarker
						}).bindPopup('<div style="height: 30px; padding: 12px 0px 0px 0px;"><a href="javascript:launchForm();" class="header__button header__button--green">Végétaliser cet espace</a></div>',
						       {autoClose:false, closeButton: false, className: 'popup--red'})
						  .addTo(map)
						  .openPopup()
						  .on('dragend', function(e) { 
						    	marker.openPopup();
						  })
						  
	}


	map.on('click', function(e) {
		selectPoint(e.latlng);
	});


	var request = new XMLHttpRequest();
	request.open('GET', 'https://geo.api.gouv.fr/communes?fields=code,nom,codesPostaux,centre,contour&nom=paris', true);

	request.onload = function() {
	  if (request.status >= 200 && request.status < 400) {
	    // Success!
	    var data = JSON.parse(request.responseText);
	    var polygon = L.geoJson(data[0]["contour"],{
		    color: '#003057',
		    fill: false
		}).addTo(map)
		var bounds = polygon.getBounds();
	    map.setMaxBounds(bounds.pad(0.05));
	    codePostaux = data[0]["codesPostaux"];
	    //var centre = L.geoJson(data[0]["centre"]).addTo(map);
	  } else {
	    // We reached our target server, but it returned an error

	  }
	};
	request.send();

	var requestArea = new XMLHttpRequest();
	requestArea.open('GET', 'data/area.geojson', true);

	requestArea.onload = function() {
	  if (requestArea.status >= 200 && requestArea.status < 400) {
	    // Success!
	    var data = JSON.parse(requestArea.responseText);
	    var layer = L.geoJson(data["features"], {
							    style: function (feature) {
							        return {color: feature.properties._storage_options.color,
							        	opacity: feature.properties._storage_options.opacity,
							        		clickable: false};
							    }
							})
	    					.addTo(map)
	    
	  } else {
	    // We reached our target server, but it returned an error

	  }
	};
	requestArea.send();


	var requestVerts = new XMLHttpRequest();
	requestVerts.open('GET', 'https://opendata.paris.fr/api/records/1.0/search/?dataset=du-vert-pres-de-chez-moi&rows=1000&facet=etat_de_la_proposition&refine.etat_de_la_proposition=proposition+r%C3%A9alisable+et+retenue+dans+les+200+points+de+v%C3%A9g%C3%A9talisation', true);

	var plantMarker = L.AwesomeMarkers.icon({
    	icon: 'leaf',
    	markerColor: 'green',
    	prefix: 'fa'
  	});

	requestVerts.onload = function() {
	  if (requestVerts.status >= 200 && requestVerts.status < 400) {
	    // Success!
	    var data = JSON.parse(requestVerts.responseText);

	    data["records"].map(function(feature){
	    		var layer = L.geoJson(feature["geometry"], {
							    pointToLayer: function(geoJsonPoint, latlng) {
    								return L.marker(latlng, {icon: plantMarker}).bindPopup(feature["fields"]["type_veget"]);
								}
							})
	    					.addTo(map)
	    })
	    
	  } else {
	    // We reached our target server, but it returned an error

	  }
	};
	requestVerts.send();


// Autocomplete
	var addressSearch = document.getElementById('address-search');
	L.DomEvent.disableClickPropagation(addressSearch);
	addressSearch.onmouseover = map.dragging.disable();
	addressSearch.onmouseout = map.dragging.enable();


	function renderFeature(item, search){
    	var coord = item["geometry"]["coordinates"]
		return '<div class="autocomplete-suggestion" data-val="' + item["properties"]["label"] + '" data-lat="'+coord[1]+'" data-lng="'+coord[0]+'">' + item["properties"]["label"] + '</div>';
	}

	function onSelectAddress(event, term, item){
		//input.placeholder = item.getAttribute("data-val");
		var coord = [item.getAttribute("data-lat"),item.getAttribute("data-lng")];
		selectPoint(coord);
		map.flyTo(coord, 17);
	}

	function addressesDataSource(term, response){
    		try { requestAddresses.abort(); } catch(e){}
			requestAddresses = new XMLHttpRequest();
			requestAddresses.open('GET', 'https://api-adresse.data.gouv.fr/search/?q='+term+'&limit=30&lon='+center[0]+'&lat='+center[1], true);
    		requestAddresses.onload = function() {
			  if (requestAddresses.status >= 200 && requestAddresses.status < 400) {
			    // Success!
			    var data = JSON.parse(requestAddresses.responseText);
			    var features = data["features"].filter(function(feature){
			    	if(codePostaux.indexOf(feature["properties"]["postcode"]) == -1) {
			    		return false;
			    	}
			    	return true;
			    });
			    response(features);
			  } else {
			    response([]);
			  }
			};
			requestAddresses.send();
    	}

	var requestAddresses;
	new autoComplete({
    	selector: 'input[name=address-search]',
    	minChars: 2,
    	source: addressesDataSource,
    	renderItem: renderFeature,
		onSelect: onSelectAddress,
		cache: false,
	});

	function launchForm() {
		document.getElementById('footer').classList.add('footer--invisible');
		var permitForm = document.getElementById('permit__form');
		permitForm.classList.remove('main__form--invisible');
		permitForm.scrollIntoView();
	}

</script>
</body>
</html>
