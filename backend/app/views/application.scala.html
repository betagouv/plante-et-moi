@(application: models.Application, agent: Agent, reviews: List[(Review, Agent)])
@import java.util.Locale

@main(agent)(s"${application.address} (${application._type}) - #${application.id.substring(0,2)}")  {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@@1.0.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@@1.0.1/dist/leaflet.js"></script>
    <script src='@routes.Assets.versioned("javascripts/Leaflet+Data.js")'></script>
<style>
.mdl-list__item-primary-content {
    font-weight: bold;
}
.map__leaflet {
    height: 250px;
}
.application__key {
    width: 35%;
    font-weight: bold;
}
.application__value {
    width: 65%;
}
.application {
    white-space: normal;
}
</style>
}{
<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid" style="text-align: center;">
    <div class="map__leaflet mdl-cell mdl-cell--12-col" id="map">
    </div>
</div>

<table class="application mdl-data-table mdl-js-data-table mdl-cell @if(application.imagesFiles().isEmpty) {mdl-cell--12-col} else {mdl-cell--9-col} mdl-cell--12-col-tablet mdl-shadow--2dp">
    <tbody>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key" >Adresse du projet</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application.address</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Type</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application._type</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Date de dépot</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application.creationDate.toString("dd MMM YYYY", new Locale("fr"))</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Nom du demandeur</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application.name</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Courriel</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application.email</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Téléphone</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application.phone</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Avancement</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@application.status</td>
    </tr>
    @for((key,value) <- application.fields) {
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">@key</td>
        <td class="mdl-data-table__cell--non-numeric application__value">@value</td>
    </tr>
    }
    @application.files.map { file =>
    <tr>
        <td class="mdl-data-table__cell--non-numeric application__key">Fichier</td>
        <td class="mdl-data-table__cell--non-numeric application__value"><a href='@routes.ApplicationController.getImage(file)'>@file.split('/').last</a></td>
    </tr>
    }
    </tbody>
</table>
@if(!application.imagesFiles().isEmpty) {
<div class="mdl-cell mdl-cell--3-col mdl-cell--12-col-tablet mdl-cell--12-col-phone mdl-grid mdl-grid--no-spacing">
    @application.imagesFiles().map { file =>
    <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col">
        <img src='@routes.ApplicationController.getImage(file)' style="width: 100%; margin: 0px;">
    </div>
    <div class="mdl-cell--1-col" style="height: 20px"></div>
    }
</div>
}

@if(application.status == "Nouvelle") {
    @if(agent.admin) {
<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
    <form action='@routes.ApplicationController.updateStatus(application.id, "En cours")' class="mdl-cell mdl-cell--10-col mdl-cell--1-offset-desktop mdl-grid" method="post">
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-cell mdl-cell--12-col">Demande complète (Demander les avis aux agents)</button>
    </form>
</div>
    }
} else {
<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
    <div class="mdl-cell mdl-cell--12-col mdl-grid">
        <h3 class="mdl-cell mdl-cell--12-col">Récapitulatif des avis</h3>
        @if(reviews.isEmpty) {
            <p>Pas encore d'avis</p>
        } else {
        <ul class="demo-list-three mdl-list mdl-cell mdl-cell--12-col">
            @for((review,reviewAgent) <- reviews) {
                <li class="mdl-list__item mdl-list__item--three-line">
                    <span class="mdl-list__item-primary-content ">
                      <i class="material-icons mdl-list__item-icon">@if(review.favorable) {check}else{block}</i>
                      <span>@reviewAgent.qualite.capitalize (@reviewAgent.name)</span>
                      <span class="mdl-list__item-text-body">
                          @application.creationDate.toString("dd MMM YYYY", new Locale("fr")) -
                          @if(!review.comment.isEmpty()) {
                                Commentaire de l'agent: `<i>@review.comment</i>`
                          } else {
                                L'agent n'a pas laissé de commentaire.
                          }
                      </span>
                    </span>
                    <span class="mdl-list__item-secondary-content">
                        <span>@if(review.favorable){Favorable}else{Défavorable}</span>
                    </span>
                </li>
            }
        </ul>
        }
    </div>
</div>
<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
    <div class="mdl-cell mdl-cell--12-col mdl-grid">
    <form action="@routes.ApplicationController.addReview(application.id)" class="mdl-grid" method="post" onsubmit="return checkForm()">
        @defining(reviews.find(_._1.agentId == agent.id).map(_._1)) { currentReview =>
            <h3 class="mdl-cell mdl-cell--12-col">@if(currentReview.isEmpty) { Ajouter } else { Modifier } mon avis en tant @if("aeiou".contains(agent.qualite.charAt(0).toLower)){ qu'} else { que }@agent.qualite</h3>
            <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect mdl-cell mdl-cell--5-col mdl-cell--1-offset" for="option-1">
                <input type="radio" id="option-1" class="mdl-radio__button" name="favorable" value="true" @if(currentReview.map(_.favorable).getOrElse(false)){checked}>
                <span class="mdl-radio__label">Favorable</span>
            </label>
            <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect mdl-cell mdl-cell--5-col mdl-cell--1-offset" for="option-2">
                <input type="radio" id="option-2" class="mdl-radio__button" name="favorable" value="false" @if(currentReview.map(!_.favorable).getOrElse(false)){checked}>
                <span class="mdl-radio__label">Défavorable</span>
            </label>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--12-col">
                <textarea class="mdl-textfield__input" type="text" rows= "5" id="sample5" style="width: 100%;" name="comment">@currentReview.map(_.comment).getOrElse("")</textarea>
                <label class="mdl-textfield__label" for="sample5">Saisir mon commentaire...</label>
            </div>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-cell mdl-cell--10-col mdl-cell--1-offset">
                @if(currentReview.isEmpty) { Ajouter } else { Modifier } mon avis
            </button>
        }
    </form>
    </div>
</div>
}
<script>
    var map = L.map('map', {
        zoom: 13,
        center: [0,0],
        minZoom: 11,
        layers: [photoLayer]
    });
    L.control.layers(baseMaps, {}, ({collapsed: false })).addTo(map);

	function addressesDataSource(term, response){
    		try { requestAddresses.abort(); } catch(e){}
			requestAddresses = new XMLHttpRequest();
			requestAddresses.open('GET', 'https://api-adresse.data.gouv.fr/search/?type=housenumber&q='+term+'&limit=30', true);
    		requestAddresses.onload = function() {
			  if (requestAddresses.status >= 200 && requestAddresses.status < 400) {
			    // Success!
			    var data = JSON.parse(requestAddresses.responseText);
			    response(data["features"]);
			  } else {
			    response([]);
			  }
			};
			requestAddresses.send();
    	}

	var requestAddresses;

    var address = "@application.address";
    var coordinates = { lat: @application.coordinates.latitude,
                  lng: @application.coordinates.longitude };

    if (coordinates.lat == 0 && coordinates.lng == 0) {
        addressesDataSource("@application.address", function(responses) {
                var coord = responses[0]["geometry"]["coordinates"];
                coordinates = { lat: coord[1], lng: coord[0] };
                setCoordinates(coordinates);
        });
    } else {
        setCoordinates(coordinates);
    }

	function setCoordinates(coordinates) {
	    map.setView(coordinates, 17);
	    L.marker(coordinates, {
			draggable: false,
			clickable: false
		}).addTo(map)
	}

	function checkForm() {
	    var favorable = document.getElementById("option-1").checked;
	    var unfavorable = document.getElementById("option-2").checked;
	    var comment = document.getElementById("sample5").value;
	    if(!favorable && !unfavorable) {
	        alert("Vous devez donner votre avis en sélectionnant un des choix");
	        return false;
	    }
	    if(unfavorable && comment == "") {
	        alert("Vous devez laisser un commentaire sur un avis défavorable");
	        return false;
	    }
	    return true;
	}
</script>
}